{"ast":null,"code":"import React,{useState,useMemo}from'react';import{useNavigate}from'react-router-dom';import RecordingControlButton from'./RecordingControlButton';import'./UserList.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const UserList=_ref=>{let{users=[],loading=false,selectedUser,onUserSelect,roleRestrictions={}// New prop for role-based restrictions\n}=_ref;const navigate=useNavigate();const[searchTerm,setSearchTerm]=useState('');const[statusFilter,setStatusFilter]=useState('all');// Filter and search users\nconst filteredUsers=useMemo(()=>{let filtered=users;// Apply search filter\nif(searchTerm){filtered=filtered.filter(user=>user.user_id.toLowerCase().includes(searchTerm.toLowerCase())||user.android_id&&user.android_id.toLowerCase().includes(searchTerm.toLowerCase())||user.device_name&&user.device_name.toLowerCase().includes(searchTerm.toLowerCase()));}// Apply status filter - only primary statuses\nif(statusFilter!=='all'){filtered=filtered.filter(user=>{const status=user.status||'unknown';return status===statusFilter;});}return filtered;},[users,searchTerm,statusFilter]);const getStatusBadge=user=>{// New 5-status system with backend status mapping\nconst status=user.status||'unknown';switch(status){case'listening':return/*#__PURE__*/_jsx(\"span\",{className:\"status-badge status-listening\",children:\"\\uD83C\\uDFA7 Listening\"});case'offline':return/*#__PURE__*/_jsx(\"span\",{className:\"status-badge status-offline\",children:\"\\uD83D\\uDD34 Offline\"});case'lost_while_listening':return/*#__PURE__*/_jsx(\"span\",{className:\"status-badge status-warning\",children:\"\\u26A0\\uFE0F Lost Connection\"});case'online':return/*#__PURE__*/_jsx(\"span\",{className:\"status-badge status-online\",children:\"\\uD83D\\uDFE2 Online\"});default:return/*#__PURE__*/_jsx(\"span\",{className:\"status-badge status-unknown\",children:\"\\u2753 Unknown\"});}};const formatLastSeen=(timestamp,date,time,timezone)=>{// Handle new date/time format from backend\nif(date&&time){// New format: separate date and time (already in Nigerian timezone from backend)\nconst dateTimeString=\"\".concat(date,\"T\").concat(time);const lastSeen=new Date(dateTimeString);if(isNaN(lastSeen.getTime()))return'Invalid date';const now=new Date();const diffMs=now-lastSeen;const diffMins=Math.floor(diffMs/60000);const diffHours=Math.floor(diffMins/60);const diffDays=Math.floor(diffHours/24);if(diffMins<1)return'Just now';if(diffMins<60)return\"\".concat(diffMins,\"m ago\");if(diffHours<24)return\"\".concat(diffHours,\"h ago\");return\"\".concat(diffDays,\"d ago\");}// Fallback to old timestamp format\nif(!timestamp)return'Never';const now=new Date();const lastSeen=new Date(timestamp);if(isNaN(lastSeen.getTime()))return'Invalid date';const diffMs=now-lastSeen;const diffMins=Math.floor(diffMs/60000);const diffHours=Math.floor(diffMins/60);const diffDays=Math.floor(diffHours/24);if(diffMins<1)return'Just now';if(diffMins<60)return\"\".concat(diffMins,\"m ago\");if(diffHours<24)return\"\".concat(diffHours,\"h ago\");return\"\".concat(diffDays,\"d ago\");};// Format last seen timestamp\nconst getLastSeenWithColor=user=>{var _user$latest_location,_user$latest_location2;// Check if we have new format data\nconst hasNewFormat=((_user$latest_location=user.latest_location)===null||_user$latest_location===void 0?void 0:_user$latest_location.date)&&((_user$latest_location2=user.latest_location)===null||_user$latest_location2===void 0?void 0:_user$latest_location2.time);let lastSeenText;if(hasNewFormat){// Use new date/time format\nlastSeenText=formatLastSeen(null,user.latest_location.date,user.latest_location.time,user.latest_location.timezone);}else{// Fallback to old timestamp format\nlastSeenText=formatLastSeen(user.last_seen);}if(lastSeenText==='Never'||lastSeenText==='Invalid date'){return/*#__PURE__*/_jsx(\"span\",{className:\"last-seen-text\",children:\"Never\"});}const timezoneLabel=hasNewFormat?' (WAT)':'';return/*#__PURE__*/_jsxs(\"span\",{className:\"last-seen-text\",children:[lastSeenText,timezoneLabel]});};const handleDeviceClick=user=>{// Check role restrictions before navigation\nif(roleRestrictions.hideDeviceDetails){// For operators, prevent device detail access\nreturn;}if(roleRestrictions.restrictedAccess){// For analysts, only navigate to assigned devices\nnavigate(\"/device/\".concat(user.android_id||user.user_id));}else{// Full access\nnavigate(\"/device/\".concat(user.android_id||user.user_id));}};const shouldShowRecordingControl=user=>{if(roleRestrictions.hideRecordingControls)return false;if(roleRestrictions.showRecordingControls)return true;return true;// Default behavior\n};const getBatteryColorClass=batteryLevel=>{if(batteryLevel>=75)return'battery-high';if(batteryLevel>=25)return'battery-medium';return'battery-low';};const handleRecordingStatusChange=(deviceId,recordingStatus)=>{// This function is called when a recording control button updates\n// We could update local state here if needed, but the polling will handle it\n};const getRecordingState=user=>{const recordingStatus=user.recording_status;if(!recordingStatus)return'idle';// Map backend status to button state\nconst state=recordingStatus.recording_state;// Handle offline devices\nif(!recordingStatus.can_control&&recordingStatus.last_seen_minutes>7){return'offline';}return state;};const getDeviceCardClass=user=>{let baseClass='user-card';// Add clickable class if device can be clicked\nif(!roleRestrictions.hideDeviceDetails){baseClass+=' clickable-card';}// Add selected class if this user is selected\nif(selectedUser&&selectedUser.user_id===user.user_id){baseClass+=' selected';}return baseClass;};if(loading&&users.length===0){return/*#__PURE__*/_jsxs(\"div\",{className:\"user-list-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"user-list-header\",children:/*#__PURE__*/_jsx(\"h2\",{children:\"\\uD83E\\uDD87 Connected Devices\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"loading-users\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Loading users...\"})]})]});}return/*#__PURE__*/_jsxs(\"div\",{className:\"user-list-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"user-list-header\",children:[/*#__PURE__*/_jsxs(\"h2\",{children:[\"\\uD83E\\uDD87 Connected Devices (\",filteredUsers.length,\")\"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-list-controls\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"search-container\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Search devices...\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"search-input\"}),/*#__PURE__*/_jsx(\"span\",{className:\"search-icon\",children:\"\\uD83D\\uDD0D\"})]}),/*#__PURE__*/_jsxs(\"select\",{value:statusFilter,onChange:e=>setStatusFilter(e.target.value),className:\"status-filter\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"all\",children:\"All Status\"}),/*#__PURE__*/_jsx(\"option\",{value:\"listening\",children:\"\\uD83C\\uDFA7 Listening\"}),/*#__PURE__*/_jsx(\"option\",{value:\"online\",children:\"\\uD83D\\uDFE2 Online\"}),/*#__PURE__*/_jsx(\"option\",{value:\"offline\",children:\"\\uD83D\\uDD34 Offline\"})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"user-list\",children:filteredUsers.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"no-users\",children:[/*#__PURE__*/_jsx(\"p\",{children:searchTerm||statusFilter!=='all'?'ðŸ” No devices match your search criteria':'ðŸ“± No devices connected yet'}),searchTerm&&/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-secondary\",onClick:()=>setSearchTerm(''),children:\"Clear Search\"})]}):filteredUsers.map(user=>{var _user$location,_user$location2,_user$battery,_user$battery2,_user$uploads;return/*#__PURE__*/_jsxs(\"div\",{className:getDeviceCardClass(user),onClick:()=>handleDeviceClick(user),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"user-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"user-info\",children:[/*#__PURE__*/_jsxs(\"h3\",{className:\"user-id\",children:[\"\\uD83D\\uDCF1 \",user.display_name||user.user_id]}),user.android_id&&/*#__PURE__*/_jsxs(\"p\",{className:\"android-id\",children:[\"Android ID: \",user.android_id]}),/*#__PURE__*/_jsxs(\"p\",{className:\"user-location\",children:[\"\\uD83D\\uDCCD \",(((_user$location=user.location)===null||_user$location===void 0?void 0:_user$location.lat)||0).toFixed(4),\", \",(((_user$location2=user.location)===null||_user$location2===void 0?void 0:_user$location2.lng)||0).toFixed(4)]}),((_user$battery=user.battery)===null||_user$battery===void 0?void 0:_user$battery.level)!==null&&((_user$battery2=user.battery)===null||_user$battery2===void 0?void 0:_user$battery2.level)!==undefined&&/*#__PURE__*/_jsxs(\"p\",{className:\"user-battery\",children:[\"\\uD83D\\uDD0B \",user.battery.level,\"%\",user.battery.is_charging&&/*#__PURE__*/_jsx(\"span\",{className:\"charging-indicator\",children:\"\\u26A1\"})]})]}),getStatusBadge(user)]}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-details\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"user-stats\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Recordings:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:((_user$uploads=user.uploads)===null||_user$uploads===void 0?void 0:_user$uploads.length)||0})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Last Seen:\"}),getLastSeenWithColor(user)]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-actions\",children:[shouldShowRecordingControl(user)&&/*#__PURE__*/_jsx(RecordingControlButton,{deviceId:user.android_id||user.user_id,initialStatus:getRecordingState(user),onStatusChange:handleRecordingStatusChange,disabled:loading}),roleRestrictions.restrictedAccess&&/*#__PURE__*/_jsx(\"div\",{className:\"role-notice\",children:/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83D\\uDD0D Assigned Device\"})})]})]})]},user.user_id);})})]});};export default UserList;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}