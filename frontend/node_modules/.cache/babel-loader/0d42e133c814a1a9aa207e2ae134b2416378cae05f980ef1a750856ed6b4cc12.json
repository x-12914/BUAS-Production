{"ast":null,"code":"import _objectSpread from\"/home/opt/BUAS/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{useParams,useNavigate}from'react-router-dom';import ApiService from'../services/api';import'./ExternalStorageBrowser.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const ExternalStorageBrowser=()=>{const{deviceId}=useParams();const navigate=useNavigate();const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[metadata,setMetadata]=useState(null);const[currentPath,setCurrentPath]=useState('/sdcard');const[currentItems,setCurrentItems]=useState([]);const[expandedFolders,setExpandedFolders]=useState(new Set());const[searchQuery,setSearchQuery]=useState('');const[searchResults,setSearchResults]=useState([]);const[isSearching,setIsSearching]=useState(false);const[pagination,setPagination]=useState({page:1,per_page:50,total:0,pages:0,has_next:false,has_prev:false});const[filters,setFilters]=useState({file_type:'all',sort_by:'name',sort_order:'asc',per_page:'50'});const[selectedItems,setSelectedItems]=useState(new Set());const[showPreview,setShowPreview]=useState(false);const[previewItem,setPreviewItem]=useState(null);const[downloadRequests,setDownloadRequests]=useState(new Map());// Live updates state\nconst[lastUpdate,setLastUpdate]=useState(null);const[isLiveMode,setIsLiveMode]=useState(true);// Define functions first to avoid hoisting issues\nconst loadFileSystemTree=async()=>{try{setLoading(true);const response=await ApiService.get(\"/api/device/\".concat(deviceId,\"/file-system/tree\"));if(response){setMetadata(response.metadata);setCurrentItems(response.root_items||[]);// Adopt canonical root from the first item if available\nconst first=(response.root_items||[])[0];if(first&&first.parent_path){setCurrentPath(first.parent_path);}setPagination({page:1,per_page:50,total:response.total_items||0,pages:Math.ceil((response.total_items||0)/50),has_next:false,has_prev:false});setLastUpdate(new Date());}}catch(err){setError('Failed to load file system tree');console.error('Error loading file system tree:',err);}finally{setLoading(false);}};const loadCurrentFolder=async function(){let page=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;try{const params=new URLSearchParams({page:page.toString(),per_page:filters.per_page||'50',file_type:filters.file_type,sort_by:filters.sort_by,sort_order:filters.sort_order});// Handle path encoding properly to avoid double slash issue\n// For paths starting with /, we need to encode the path without the leading slash\nconst encodedPath=currentPath.startsWith('/')?\"/\".concat(encodeURIComponent(currentPath.substring(1))):encodeURIComponent(currentPath);const response=await ApiService.get(\"/api/device/\".concat(deviceId,\"/file-system/folder\").concat(encodedPath,\"?\").concat(params));if(response){setCurrentItems(response.items||[]);setPagination(response.pagination);setLastUpdate(new Date());}}catch(err){setError('Failed to load folder contents');console.error('Error loading folder contents:',err);}};const performSearch=async function(query){let page=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;if(!query.trim()){setSearchQuery('');setSearchResults([]);setIsSearching(false);return;}try{setIsSearching(true);const params=new URLSearchParams({q:query,page:page.toString(),per_page:'50',file_type:filters.file_type});const response=await ApiService.get(\"/api/device/\".concat(deviceId,\"/file-system/search?\").concat(params));if(response){setSearchResults(response.results||[]);setPagination(response.pagination);setLastUpdate(new Date());}}catch(err){setError('Search failed');console.error('Error searching files:',err);}finally{setIsSearching(false);}};const handleFolderClick=folder=>{if(!folder.is_directory)return;// Prevent infinite navigation when a folder's path equals currentPath\nif(folder.path===currentPath)return;// Normalize duplicate slashes\nconst nextPath=folder.path.replace(/\\/+/,'/');setCurrentPath(nextPath);setSearchQuery('');setSearchResults([]);setIsSearching(false);loadCurrentFolder(1);};const handleBackClick=()=>{const parts=currentPath.split('/').filter(Boolean);if(parts.length<=1)return;// already at root for this storage\nconst parentPath='/'+parts.slice(0,-1).join('/');setCurrentPath(parentPath);setSearchQuery('');setSearchResults([]);setIsSearching(false);loadCurrentFolder(1);};const handleSearch=query=>{setSearchQuery(query);if(query.trim()){performSearch(query,1);}else{setSearchResults([]);setIsSearching(false);loadCurrentFolder(1);}};const handleFilterChange=newFilters=>{setFilters(prev=>_objectSpread(_objectSpread({},prev),newFilters));if(searchQuery){performSearch(searchQuery,1);}else{loadCurrentFolder(1);}};const handlePageChange=page=>{if(searchQuery){performSearch(searchQuery,page);}else{loadCurrentFolder(page);}};const handleFileDownload=async file=>{try{// Step 1: Request the download\nconst response=await ApiService.post(\"/api/device/\".concat(deviceId,\"/file/\").concat(encodeURIComponent(file.path),\"/download\"));if(response&&response.request_id){// Update download requests state\nsetDownloadRequests(prev=>new Map(prev.set(file.path,_objectSpread(_objectSpread({},response),{},{status:'pending',request_id:response.request_id}))));// Step 2: Poll for download completion\npollDownloadStatus(file.path,response.request_id);}}catch(err){console.error('Error requesting file download:',err);// Show error to user\nsetDownloadRequests(prev=>new Map(prev.set(file.path,{status:'error',error:err.message||'Failed to request download'})));}};const pollDownloadStatus=async(filePath,requestId)=>{const maxAttempts=30;// 30 attempts = 5 minutes max\nlet attempts=0;const poll=async()=>{try{const statusResponse=await ApiService.get(\"/api/device/\".concat(deviceId,\"/download-request/\").concat(requestId,\"/status\"));if(statusResponse){setDownloadRequests(prev=>new Map(prev.set(filePath,_objectSpread(_objectSpread({},statusResponse),{},{status:statusResponse.request_status}))));if(statusResponse.request_status==='completed'&&statusResponse.download_url){// Step 3: Download the file\ndownloadFileFromUrl(statusResponse.download_url,statusResponse.file_name);return;// Stop polling\n}else if(statusResponse.request_status==='failed'){console.error('Download failed:',statusResponse);return;// Stop polling\n}}// Continue polling if still pending\nattempts++;if(attempts<maxAttempts){setTimeout(poll,10000);// Poll every 10 seconds\n}else{// Timeout\nsetDownloadRequests(prev=>new Map(prev.set(filePath,{status:'timeout',error:'Download request timed out'})));}}catch(err){console.error('Error polling download status:',err);setDownloadRequests(prev=>new Map(prev.set(filePath,{status:'error',error:'Failed to check download status'})));}};// Start polling\npoll();};const downloadFileFromUrl=(downloadUrl,fileName)=>{try{// Create download link\nconst link=document.createElement('a');link.href=\"\".concat(ApiService.baseURL).concat(downloadUrl);link.download=fileName;link.target='_blank';link.rel='noopener noreferrer';// Trigger download\ndocument.body.appendChild(link);link.click();document.body.removeChild(link);// Update status to downloaded\nsetDownloadRequests(prev=>new Map(prev.set(fileName,{status:'downloaded',download_url:downloadUrl})));}catch(err){console.error('Error downloading file:',err);setDownloadRequests(prev=>new Map(prev.set(fileName,{status:'error',error:'Failed to download file'})));}};const renderDownloadButton=item=>{const downloadStatus=downloadRequests.get(item.path);if(!downloadStatus){// No download request yet\nreturn/*#__PURE__*/_jsx(\"button\",{className:\"download-button\",onClick:e=>{e.stopPropagation();handleFileDownload(item);},title:\"Download file\",children:\"\\u2B07\\uFE0F\"});}switch(downloadStatus.status){case'pending':return/*#__PURE__*/_jsx(\"span\",{className:\"download-status\",title:\"Download requested, waiting for device...\",children:\"\\u23F3\"});case'downloading':return/*#__PURE__*/_jsx(\"span\",{className:\"download-status\",title:\"Downloading from device...\",children:\"\\uD83D\\uDCE5\"});case'completed':return/*#__PURE__*/_jsx(\"span\",{className:\"download-status\",title:\"Download completed\",children:\"\\u2705\"});case'downloaded':return/*#__PURE__*/_jsx(\"span\",{className:\"download-status\",title:\"File downloaded\",children:\"\\u2705\"});case'failed':return/*#__PURE__*/_jsx(\"button\",{className:\"download-button error\",onClick:e=>{e.stopPropagation();handleFileDownload(item);},title:\"Download failed: \".concat(downloadStatus.error||'Unknown error'),children:\"\\u274C\"});case'timeout':return/*#__PURE__*/_jsx(\"button\",{className:\"download-button error\",onClick:e=>{e.stopPropagation();handleFileDownload(item);},title:\"Download timed out, click to retry\",children:\"\\u23F0\"});case'error':return/*#__PURE__*/_jsx(\"button\",{className:\"download-button error\",onClick:e=>{e.stopPropagation();handleFileDownload(item);},title:\"Error: \".concat(downloadStatus.error||'Unknown error'),children:\"\\u274C\"});default:return/*#__PURE__*/_jsx(\"button\",{className:\"download-button\",onClick:e=>{e.stopPropagation();handleFileDownload(item);},title:\"Download file\",children:\"\\u2B07\\uFE0F\"});}};const handleItemPreview=item=>{if(!item.is_directory){setPreviewItem(item);setShowPreview(true);}};const getFileIcon=item=>{var _item$file_extension;if(item.is_directory){return'ðŸ“';}const extension=(_item$file_extension=item.file_extension)===null||_item$file_extension===void 0?void 0:_item$file_extension.toLowerCase();if(['jpg','jpeg','png','gif','bmp','webp'].includes(extension)){return'ðŸ–¼ï¸';}else if(['mp4','avi','mov','mkv','3gp'].includes(extension)){return'ðŸŽ¥';}else if(['mp3','wav','aac','m4a','ogg'].includes(extension)){return'ðŸŽµ';}else if(['pdf','doc','docx','txt','rtf'].includes(extension)){return'ðŸ“„';}else if(['apk','zip','rar','7z'].includes(extension)){return'ðŸ“¦';}else{return'ðŸ“„';}};const formatDate=dateString=>{if(!dateString)return'Unknown';return new Date(dateString).toLocaleString();};const getDisplayItems=()=>{return isSearching?searchResults:currentItems;};const getBreadcrumbs=()=>{const parts=currentPath.split('/').filter(Boolean);if(parts.length===0){return[{name:'Root',path:'/sdcard'}];}// Root is the first segment of the path (e.g., /sdcard or /storage or /storage/emulated/0)\nlet breadcrumbPath='/'+parts[0];const breadcrumbs=[{name:'Root',path:breadcrumbPath}];for(let i=1;i<parts.length;i++){breadcrumbPath+='/'+parts[i];breadcrumbs.push({name:parts[i],path:breadcrumbPath});}return breadcrumbs;};// Load initial data\nuseEffect(()=>{loadFileSystemTree();},[deviceId]);// Live updates polling\nuseEffect(()=>{if(!isLiveMode)return;const interval=setInterval(()=>{if(searchQuery){performSearch(searchQuery,1);}else{loadCurrentFolder();}},5000);// Update every 5 seconds\nreturn()=>clearInterval(interval);},[isLiveMode,searchQuery,currentPath,filters]);if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"external-storage-browser\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"loading-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Loading file system...\"})]})});}if(error){return/*#__PURE__*/_jsx(\"div\",{className:\"external-storage-browser\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"error-container\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"Error\"}),/*#__PURE__*/_jsx(\"p\",{children:error}),/*#__PURE__*/_jsxs(\"div\",{className:\"error-actions\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate(\"/device/\".concat(deviceId)),className:\"back-button\",children:\"\\u2190 Back to Device Details\"}),/*#__PURE__*/_jsx(\"button\",{onClick:loadFileSystemTree,className:\"retry-button\",children:\"Retry\"})]})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"external-storage-browser\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"browser-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"header-top\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate(\"/device/\".concat(deviceId)),className:\"back-button\",children:\"\\u2190 Back to Device Details\"}),/*#__PURE__*/_jsx(\"h2\",{children:\"\\uD83D\\uDCC1 External Storage Browser\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"header-controls\",children:[/*#__PURE__*/_jsxs(\"label\",{className:\"live-mode-toggle\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:isLiveMode,onChange:e=>setIsLiveMode(e.target.checked)}),\"Live Updates\"]}),lastUpdate&&/*#__PURE__*/_jsxs(\"span\",{className:\"last-update\",children:[\"Last updated: \",lastUpdate.toLocaleTimeString()]})]})]}),metadata&&/*#__PURE__*/_jsxs(\"div\",{className:\"metadata-bar\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"metadata-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"metadata-label\",children:\"Total Files:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"metadata-value\",children:metadata.total_files.toLocaleString()})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"metadata-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"metadata-label\",children:\"Total Folders:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"metadata-value\",children:metadata.total_folders.toLocaleString()})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"metadata-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"metadata-label\",children:\"Total Size:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"metadata-value\",children:metadata.total_size_formatted})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"metadata-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"metadata-label\",children:\"Last Scan:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"metadata-value\",children:formatDate(metadata.timestamp)})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"search-filters\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"search-bar\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Search files and folders...\",value:searchQuery,onChange:e=>handleSearch(e.target.value),className:\"search-input\"}),isSearching&&/*#__PURE__*/_jsx(\"div\",{className:\"search-spinner\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filters\",children:[/*#__PURE__*/_jsxs(\"select\",{value:filters.file_type,onChange:e=>handleFilterChange({file_type:e.target.value}),className:\"filter-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"all\",children:\"All Types\"}),/*#__PURE__*/_jsx(\"option\",{value:\"directories\",children:\"Folders Only\"}),/*#__PURE__*/_jsx(\"option\",{value:\"files\",children:\"Files Only\"}),/*#__PURE__*/_jsx(\"option\",{value:\"Image\",children:\"Images\"}),/*#__PURE__*/_jsx(\"option\",{value:\"Video\",children:\"Videos\"}),/*#__PURE__*/_jsx(\"option\",{value:\"Audio\",children:\"Audio\"}),/*#__PURE__*/_jsx(\"option\",{value:\"Document\",children:\"Documents\"}),/*#__PURE__*/_jsx(\"option\",{value:\"Archive\",children:\"Archives\"})]}),/*#__PURE__*/_jsxs(\"select\",{value:filters.sort_by,onChange:e=>handleFilterChange({sort_by:e.target.value}),className:\"filter-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"name\",children:\"Sort by Name\"}),/*#__PURE__*/_jsx(\"option\",{value:\"size\",children:\"Sort by Size\"}),/*#__PURE__*/_jsx(\"option\",{value:\"date\",children:\"Sort by Date\"}),/*#__PURE__*/_jsx(\"option\",{value:\"type\",children:\"Sort by Type\"})]}),/*#__PURE__*/_jsxs(\"select\",{value:filters.sort_order,onChange:e=>handleFilterChange({sort_order:e.target.value}),className:\"filter-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"asc\",children:\"Ascending\"}),/*#__PURE__*/_jsx(\"option\",{value:\"desc\",children:\"Descending\"})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"breadcrumbs\",children:getBreadcrumbs().map((crumb,index)=>/*#__PURE__*/_jsxs(React.Fragment,{children:[index>0&&/*#__PURE__*/_jsx(\"span\",{className:\"breadcrumb-separator\",children:\"/\"}),/*#__PURE__*/_jsx(\"button\",{className:\"breadcrumb-item \".concat(crumb.path===currentPath?'active':''),onClick:()=>{setCurrentPath(crumb.path);setSearchQuery('');setSearchResults([]);setIsSearching(false);loadCurrentFolder(1);},children:crumb.name})]},crumb.path))})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"file-list-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"file-list\",children:getDisplayItems().length===0?/*#__PURE__*/_jsx(\"div\",{className:\"empty-state\",children:/*#__PURE__*/_jsx(\"p\",{children:isSearching?'No files found matching your search.':'This folder is empty.'})}):getDisplayItems().map(item=>/*#__PURE__*/_jsxs(\"div\",{className:\"file-item \".concat(item.is_directory?'directory':'file',\" \").concat(selectedItems.has(item.path)?'selected':''),onClick:()=>handleItemPreview(item),onDoubleClick:()=>handleFolderClick(item),children:[/*#__PURE__*/_jsx(\"div\",{className:\"file-icon\",children:getFileIcon(item)}),/*#__PURE__*/_jsxs(\"div\",{className:\"file-info\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"file-name\",title:item.name,children:item.name}),/*#__PURE__*/_jsxs(\"div\",{className:\"file-details\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"file-size\",children:item.size_formatted}),/*#__PURE__*/_jsx(\"span\",{className:\"file-date\",children:formatDate(item.last_modified)}),/*#__PURE__*/_jsx(\"span\",{className:\"file-type\",children:item.file_type})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"file-actions\",children:!item.is_directory&&renderDownloadButton(item)})]},item.path))}),pagination.pages>1&&/*#__PURE__*/_jsxs(\"div\",{className:\"pagination\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"pagination-button\",onClick:()=>handlePageChange(pagination.page-1),disabled:!pagination.has_prev,children:\"Previous\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"pagination-info\",children:[\"Page \",pagination.page,\" of \",pagination.pages,\" (\",pagination.total,\" items)\"]}),/*#__PURE__*/_jsx(\"button\",{className:\"pagination-button\",onClick:()=>handlePageChange(pagination.page+1),disabled:!pagination.has_next,children:\"Next\"})]})]}),showPreview&&previewItem&&/*#__PURE__*/_jsx(\"div\",{className:\"preview-modal-overlay\",onClick:()=>setShowPreview(false),children:/*#__PURE__*/_jsxs(\"div\",{className:\"preview-modal\",onClick:e=>e.stopPropagation(),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"preview-header\",children:[/*#__PURE__*/_jsx(\"h3\",{children:previewItem.name}),/*#__PURE__*/_jsx(\"button\",{className:\"close-button\",onClick:()=>setShowPreview(false),children:\"\\u2715\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"preview-content\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"preview-icon\",children:getFileIcon(previewItem)}),/*#__PURE__*/_jsxs(\"div\",{className:\"preview-details\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"preview-detail\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Path:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:previewItem.path})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"preview-detail\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Size:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:previewItem.size_formatted})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"preview-detail\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Type:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:previewItem.file_type})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"preview-detail\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Modified:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:formatDate(previewItem.last_modified)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"preview-detail\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Permissions:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:previewItem.permissions})]}),previewItem.file_hash&&/*#__PURE__*/_jsxs(\"div\",{className:\"preview-detail\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Hash:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:previewItem.file_hash})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"preview-actions\",children:/*#__PURE__*/_jsx(\"button\",{className:\"download-button\",onClick:()=>{handleFileDownload(previewItem);setShowPreview(false);},children:\"Download File\"})})]})})]});};export default ExternalStorageBrowser;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}