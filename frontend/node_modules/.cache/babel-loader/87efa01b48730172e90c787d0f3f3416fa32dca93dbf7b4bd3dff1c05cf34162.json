{"ast":null,"code":"import _objectSpread from\"/home/opt/BUAS/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{useParams,useNavigate,useLocation}from'react-router-dom';import CallLogsTable from'./CallLogsTable';import ApiService from'../services/api';import'./DeviceCallLogsHistory.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const DeviceCallLogsHistory=()=>{var _location$state,_location$state2,_location$state3;const{deviceId}=useParams();const navigate=useNavigate();const location=useLocation();// Debug logging\nconsole.log('DeviceCallLogsHistory - deviceId:',deviceId);console.log('DeviceCallLogsHistory - current location:',location.pathname);const[callLogsData,setCallLogsData]=useState(((_location$state=location.state)===null||_location$state===void 0?void 0:_location$state.callLogsData)||[]);const[deviceInfo,setDeviceInfo]=useState(((_location$state2=location.state)===null||_location$state2===void 0?void 0:_location$state2.deviceInfo)||null);const[loading,setLoading]=useState(!((_location$state3=location.state)!==null&&_location$state3!==void 0&&_location$state3.callLogsData));const[error,setError]=useState(null);const[summary,setSummary]=useState({total_calls:0,incoming_calls:0,outgoing_calls:0,missed_calls:0,total_duration:0,unique_numbers:0});// Filter state for API calls\nconst[numberFilter,setNumberFilter]=useState('');const[typeFilter,setTypeFilter]=useState('');const[dateFromFilter,setDateFromFilter]=useState('');const[dateToFilter,setDateToFilter]=useState('');const[minDurationFilter,setMinDurationFilter]=useState('');// Helper function to fetch all Call Logs data across multiple pages\nconst fetchAllCallLogsData=async baseParams=>{let allCallLogsData=[];let page=1;let hasMore=true;let totalSummary={};while(hasMore){const params=_objectSpread(_objectSpread({},baseParams),{},{page:page,per_page:100// Use max allowed per page\n});const response=await ApiService.getDeviceCallLogs(deviceId,params);if(response.call_logs&&response.call_logs.length>0){var _response$pagination;allCallLogsData=[...allCallLogsData,...response.call_logs];totalSummary=response.summary||{};hasMore=((_response$pagination=response.pagination)===null||_response$pagination===void 0?void 0:_response$pagination.has_next)||false;page++;}else{hasMore=false;}}return{call_logs:allCallLogsData,summary:totalSummary};};const fetchData=async()=>{try{var _location$state4;const baseParams={};if(dateFromFilter)baseParams.date_from=dateFromFilter;if(dateToFilter)baseParams.date_to=dateToFilter;if(numberFilter)baseParams.number=numberFilter;if(typeFilter)baseParams.type=typeFilter;if(minDurationFilter)baseParams.min_duration=minDurationFilter;const[callLogsResponse,deviceResponse]=await Promise.all([fetchAllCallLogsData(baseParams),(_location$state4=location.state)!==null&&_location$state4!==void 0&&_location$state4.deviceInfo?Promise.resolve({data:location.state.deviceInfo}):ApiService.getDeviceDetails(deviceId)]);setCallLogsData(callLogsResponse.call_logs||[]);setSummary(callLogsResponse.summary||{});setDeviceInfo(deviceResponse.data);setError(null);}catch(err){setError('Failed to load call logs data');console.error('Error fetching call logs data:',err);}finally{setLoading(false);}};useEffect(()=>{// Initial load and filter changes\nfetchData();// Continue real-time polling regardless\nconst interval=setInterval(()=>fetchData(),10000);return()=>clearInterval(interval);},[deviceId,location.state,dateFromFilter,dateToFilter,numberFilter,typeFilter,minDurationFilter]);// Handler for data refresh after changes\nconst handleDataChange=async()=>{try{const baseParams={};if(dateFromFilter)baseParams.date_from=dateFromFilter;if(dateToFilter)baseParams.date_to=dateToFilter;if(numberFilter)baseParams.number=numberFilter;if(typeFilter)baseParams.type=typeFilter;if(minDurationFilter)baseParams.min_duration=minDurationFilter;const callLogsResponse=await fetchAllCallLogsData(baseParams);setCallLogsData(callLogsResponse.call_logs||[]);setSummary(callLogsResponse.summary||{});}catch(err){console.error('Error refreshing call logs data:',err);}};// Handlers for filter changes\nconst handleFilterChange=filters=>{setNumberFilter(filters.numberFilter||'');setTypeFilter(filters.typeFilter||'');setDateFromFilter(filters.dateFromFilter||'');setDateToFilter(filters.dateToFilter||'');setMinDurationFilter(filters.minDurationFilter||'');};if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"device-call-logs-history-container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"loading-call-logs\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Loading call logs...\"})]})});}if(error){return/*#__PURE__*/_jsx(\"div\",{className:\"device-call-logs-history-container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"error-state\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"\\u274C Error\"}),/*#__PURE__*/_jsx(\"p\",{children:error}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate(\"/device/\".concat(deviceId)),className:\"btn btn-secondary\",children:\"\\u2190 Back to Device Details\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"device-call-logs-history-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"call-logs-history-header\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:e=>{e.preventDefault();e.stopPropagation();console.log('Back button clicked!');console.log('DeviceId:',deviceId);console.log('Current location:',location.pathname);// Use window.location.href for reliable navigation\nwindow.location.href=\"/device/\".concat(deviceId);},className:\"back-button\",style:{position:'relative',zIndex:1000,pointerEvents:'auto'},children:\"\\u2190 Back to Device Details\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-logs-history-title\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\uD83D\\uDCDE Device Call Logs\"}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Device: \",deviceId]}),deviceInfo&&/*#__PURE__*/_jsx(\"div\",{className:\"device-status-info\",children:/*#__PURE__*/_jsxs(\"span\",{className:\"call-logs-count\",children:[summary.total_calls,\" call logs\"]})})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"call-logs-table-section\",children:/*#__PURE__*/_jsx(CallLogsTable,{data:callLogsData,summary:summary,deviceId:deviceId,deviceInfo:deviceInfo,onDataChange:handleDataChange,onFilterChange:handleFilterChange})})]});};export default DeviceCallLogsHistory;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}