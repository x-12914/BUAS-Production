{"ast":null,"code":"import React,{useState,useEffect,useMemo}from'react';import ApiService from'../services/api';import'./CallLogsTable.css';import{jsxs as _jsxs,jsx as _jsx}from\"react/jsx-runtime\";const CallLogsTable=_ref=>{let{data=[],summary={},deviceId,deviceInfo,onDataChange,onFilterChange}=_ref;// Pagination state\nconst[currentPage,setCurrentPage]=useState(1);const[itemsPerPage]=useState(50);const[lastDataLength,setLastDataLength]=useState(0);// Filter states\nconst[numberFilter,setNumberFilter]=useState('');const[typeFilter,setTypeFilter]=useState('');const[dateFromFilter,setDateFromFilter]=useState('');const[dateToFilter,setDateToFilter]=useState('');const[minDurationFilter,setMinDurationFilter]=useState('');// Table states\nconst[sortField,setSortField]=useState('date');const[sortDirection,setSortDirection]=useState('desc');const[selectedCalls,setSelectedCalls]=useState(new Set());// Use data from props instead of local state\nconst callLogsData=data;// Notify parent of filter changes\nuseEffect(()=>{if(onFilterChange){onFilterChange({numberFilter,typeFilter,dateFromFilter,dateToFilter,minDurationFilter});}},[numberFilter,typeFilter,dateFromFilter,dateToFilter,minDurationFilter,onFilterChange]);// Format duration helper\nconst formatDuration=seconds=>{if(!seconds||seconds===0)return'0s';const hours=Math.floor(seconds/3600);const minutes=Math.floor(seconds%3600/60);const secs=seconds%60;if(hours>0){return\"\".concat(hours,\"h \").concat(minutes,\"m \").concat(secs,\"s\");}else if(minutes>0){return\"\".concat(minutes,\"m \").concat(secs,\"s\");}else{return\"\".concat(secs,\"s\");}};// Export functions with proper sanitization\nconst sanitizeForCSV=value=>{if(value==null)return'';const str=String(value);// Escape quotes and wrap in quotes if contains special chars\nif(str.includes(',')||str.includes('\"')||str.includes('\\n')||str.includes('\\r')){return\"\\\"\".concat(str.replace(/\"/g,'\"\"'),\"\\\"\");}return str;};const exportToCSV=async function(){let selectedOnly=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;try{let dataToExport;if(selectedOnly){// For selected only, use current page data\ndataToExport=callLogsData.filter(call=>selectedCalls.has(call.id));}else{// For export all, fetch all data from API\nconst response=await ApiService.getDeviceCallLogs(deviceId,{per_page:10000,// Large number to get all data\npage:1});dataToExport=response.call_logs||[];}if(dataToExport.length===0){alert(selectedOnly?'No calls selected for export':'No data to export');return;}const headers=['Date','Time','Number','Name','Type','Duration'];const csvContent=[headers.join(','),...dataToExport.map(call=>[sanitizeForCSV(call.call_date||call.date),sanitizeForCSV(call.call_time||call.time),sanitizeForCSV(call.phone_number||call.number),sanitizeForCSV(call.contact_name||call.name),sanitizeForCSV(call.call_type||call.type),sanitizeForCSV(formatDuration(call.duration))].join(','))].join('\\n');const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=\"call_logs_\".concat(deviceId,\"_\").concat(new Date().toISOString().split('T')[0],\".csv\");link.click();}catch(error){console.error('Export failed:',error);alert('Export failed. Please try again.');}};const exportToJSON=async function(){let selectedOnly=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;try{let dataToExport;if(selectedOnly){// For selected only, use current page data\ndataToExport=callLogsData.filter(call=>selectedCalls.has(call.id));}else{// For export all, fetch all data from API\nconst response=await ApiService.getDeviceCallLogs(deviceId,{per_page:10000,// Large number to get all data\npage:1});dataToExport=response.call_logs||[];}if(dataToExport.length===0){alert(selectedOnly?'No calls selected for export':'No data to export');return;}const exportData={device_id:deviceId,exported_at:new Date().toISOString(),call_count:dataToExport.length,call_logs:dataToExport};const blob=new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=\"call_logs_\".concat(deviceId,\"_\").concat(new Date().toISOString().split('T')[0],\".json\");link.click();}catch(error){console.error('Export failed:',error);alert('Export failed. Please try again.');}};// Selection handlers\nconst toggleSelectCall=callId=>{const newSelected=new Set(selectedCalls);if(newSelected.has(callId)){newSelected.delete(callId);}else{newSelected.add(callId);}setSelectedCalls(newSelected);};const selectAllCalls=()=>{if(selectedCalls.size===callLogsData.length){setSelectedCalls(new Set());}else{setSelectedCalls(new Set(callLogsData.map(call=>call.id)));}};// Sort handler\nconst handleSort=field=>{if(sortField===field){setSortDirection(sortDirection==='asc'?'desc':'asc');}else{setSortField(field);setSortDirection('desc');}};// Local sorting and filtering for current page\nconst processedData=useMemo(()=>{let processed=[...callLogsData];// Sort data\nprocessed.sort((a,b)=>{let aValue,bValue;switch(sortField){case'date':aValue=new Date(\"\".concat(a.call_date||a.date,\"T\").concat(a.call_time||a.time));bValue=new Date(\"\".concat(b.call_date||b.date,\"T\").concat(b.call_time||b.time));break;case'number':aValue=(a.phone_number||a.number||'').toLowerCase();bValue=(b.phone_number||b.number||'').toLowerCase();break;case'name':aValue=(a.contact_name||a.name||'').toLowerCase();bValue=(b.contact_name||b.name||'').toLowerCase();break;case'type':aValue=a.call_type||a.type;bValue=b.call_type||b.type;break;case'duration':aValue=a.duration||0;bValue=b.duration||0;break;default:return 0;}if(sortDirection==='asc'){return aValue>bValue?1:-1;}else{return aValue<bValue?1:-1;}});return processed;},[callLogsData,sortField,sortDirection]);// Pagination logic\nconst totalItems=processedData.length;const totalPages=Math.ceil(totalItems/itemsPerPage);const startIndex=(currentPage-1)*itemsPerPage;const endIndex=startIndex+itemsPerPage;const paginatedData=processedData.slice(startIndex,endIndex);// Reset to first page only when data changes significantly (filter changes)\nuseEffect(()=>{const currentDataLength=data.length;// Only reset to page 1 if:\n// 1. This is the first load (lastDataLength is 0)\n// 2. The data length changed significantly (likely a filter change)\nif(currentDataLength>0&&(lastDataLength===0||Math.abs(currentDataLength-lastDataLength)>10)){setCurrentPage(1);}setLastDataLength(currentDataLength);},[data.length,lastDataLength]);// Pagination handlers\nconst goToPage=page=>{setCurrentPage(Math.max(1,Math.min(page,totalPages)));};const goToPreviousPage=()=>{goToPage(currentPage-1);};const goToNextPage=()=>{goToPage(currentPage+1);};// Reset filters\nconst clearFilters=()=>{setNumberFilter('');setTypeFilter('');setDateFromFilter('');setDateToFilter('');setMinDurationFilter('');};// Safe field access for Android data\nconst getSafeValue=function(obj,field){let defaultValue=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'Unknown';return obj&&obj[field]!==null&&obj[field]!==undefined?obj[field]:defaultValue;};// Get call type icon\nconst getCallTypeIcon=type=>{switch(type){case'incoming':return'ðŸ“ž';case'outgoing':return'ðŸ“±';case'missed':return'âŒ';default:return'ðŸ“ž';}};// Get call type class for styling\nconst getCallTypeClass=type=>{switch(type){case'incoming':return'incoming';case'outgoing':return'outgoing';case'missed':return'missed';default:return'unknown';}};return/*#__PURE__*/_jsxs(\"div\",{className:\"call-logs-table-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"call-logs-table-header\",children:[/*#__PURE__*/_jsxs(\"h2\",{children:[\"\\uD83D\\uDCDE Call Logs - \",(deviceInfo===null||deviceInfo===void 0?void 0:deviceInfo.display_name)||deviceId]}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-logs-summary\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Total:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:summary.total_calls})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Incoming:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value incoming\",children:summary.incoming_calls})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Outgoing:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value outgoing\",children:summary.outgoing_calls})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Missed:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value missed\",children:summary.missed_calls})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Total Time:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:formatDuration(summary.total_duration)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:\"Contacts:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:summary.unique_numbers})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-logs-controls\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"filters-row\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"filter-group\",children:[/*#__PURE__*/_jsx(\"label\",{children:\"Phone Number:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Filter by number...\",value:numberFilter,onChange:e=>setNumberFilter(e.target.value)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-group\",children:[/*#__PURE__*/_jsx(\"label\",{children:\"Call Type:\"}),/*#__PURE__*/_jsxs(\"select\",{value:typeFilter,onChange:e=>setTypeFilter(e.target.value),children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"All\"}),/*#__PURE__*/_jsx(\"option\",{value:\"incoming\",children:\"Incoming\"}),/*#__PURE__*/_jsx(\"option\",{value:\"outgoing\",children:\"Outgoing\"}),/*#__PURE__*/_jsx(\"option\",{value:\"missed\",children:\"Missed\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-group\",children:[/*#__PURE__*/_jsx(\"label\",{children:\"Min Duration (seconds):\"}),/*#__PURE__*/_jsx(\"input\",{type:\"number\",placeholder:\"0\",min:\"0\",value:minDurationFilter,onChange:e=>setMinDurationFilter(e.target.value)})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filters-row\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"filter-group\",children:[/*#__PURE__*/_jsx(\"label\",{children:\"From Date:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"date\",value:dateFromFilter,onChange:e=>setDateFromFilter(e.target.value)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-group\",children:[/*#__PURE__*/_jsx(\"label\",{children:\"To Date:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"date\",value:dateToFilter,onChange:e=>setDateToFilter(e.target.value)})]}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-secondary\",onClick:clearFilters,children:\"Clear Filters\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"export-controls\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"selection-info\",children:selectedCalls.size>0&&/*#__PURE__*/_jsxs(\"span\",{children:[selectedCalls.size,\" call(s) selected\"]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"export-buttons\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-export\",onClick:()=>exportToCSV(false),disabled:callLogsData.length===0,children:\"\\uD83D\\uDCC4 Export All CSV\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-export\",onClick:()=>exportToCSV(true),disabled:selectedCalls.size===0,children:\"\\uD83D\\uDCC4 Export Selected CSV\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-export\",onClick:()=>exportToJSON(false),disabled:callLogsData.length===0,children:\"\\uD83D\\uDCCA Export All JSON\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-export\",onClick:()=>exportToJSON(true),disabled:selectedCalls.size===0,children:\"\\uD83D\\uDCCA Export Selected JSON\"})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"table-container\",children:/*#__PURE__*/_jsxs(\"table\",{className:\"call-logs-table\",children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"th\",{children:/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:selectedCalls.size===callLogsData.length&&callLogsData.length>0,onChange:selectAllCalls})}),/*#__PURE__*/_jsx(\"th\",{className:\"sortable \".concat(sortField==='date'?sortDirection:''),onClick:()=>handleSort('date'),children:\"Date/Time\"}),/*#__PURE__*/_jsx(\"th\",{className:\"sortable \".concat(sortField==='number'?sortDirection:''),onClick:()=>handleSort('number'),children:\"Number\"}),/*#__PURE__*/_jsx(\"th\",{className:\"sortable \".concat(sortField==='name'?sortDirection:''),onClick:()=>handleSort('name'),children:\"Contact\"}),/*#__PURE__*/_jsx(\"th\",{className:\"sortable \".concat(sortField==='type'?sortDirection:''),onClick:()=>handleSort('type'),children:\"Type\"}),/*#__PURE__*/_jsx(\"th\",{className:\"sortable \".concat(sortField==='duration'?sortDirection:''),onClick:()=>handleSort('duration'),children:\"Duration\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:paginatedData.length===0?/*#__PURE__*/_jsx(\"tr\",{children:/*#__PURE__*/_jsx(\"td\",{colSpan:\"6\",className:\"no-data\",children:\"No call logs found\"})}):paginatedData.map(call=>/*#__PURE__*/_jsxs(\"tr\",{className:\"call-type-\".concat(getCallTypeClass(call.call_type||call.type)),children:[/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:selectedCalls.has(call.id),onChange:()=>toggleSelectCall(call.id)})}),/*#__PURE__*/_jsxs(\"td\",{className:\"datetime-cell\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"date\",children:getSafeValue(call,'call_date','No date')||getSafeValue(call,'date','No date')}),/*#__PURE__*/_jsx(\"div\",{className:\"time\",children:getSafeValue(call,'call_time','No time')||getSafeValue(call,'time','No time')})]}),/*#__PURE__*/_jsx(\"td\",{className:\"number-cell\",children:getSafeValue(call,'phone_number','Unknown number')||getSafeValue(call,'number','Unknown number')}),/*#__PURE__*/_jsx(\"td\",{className:\"name-cell\",children:getSafeValue(call,'contact_name','Unknown')||getSafeValue(call,'name','Unknown')}),/*#__PURE__*/_jsx(\"td\",{className:\"type-cell\",children:/*#__PURE__*/_jsxs(\"span\",{className:\"type-badge \".concat(getCallTypeClass(call.call_type||call.type)),children:[getCallTypeIcon(call.call_type||call.type),\" \",(getSafeValue(call,'call_type','Unknown')||getSafeValue(call,'type','Unknown')).charAt(0).toUpperCase()+(getSafeValue(call,'call_type','Unknown')||getSafeValue(call,'type','Unknown')).slice(1)]})}),/*#__PURE__*/_jsx(\"td\",{className:\"duration-cell\",children:formatDuration(call.duration||0)})]},call.id))})]})}),totalPages>1&&/*#__PURE__*/_jsx(\"div\",{className:\"pagination-section\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"pagination\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:goToPreviousPage,disabled:currentPage===1,className:\"btn btn-pagination\",children:\"\\u2190 Previous\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"page-info\",children:[\"Page \",currentPage,\" of \",totalPages,\" (\",totalItems,\" total calls)\"]}),/*#__PURE__*/_jsx(\"button\",{onClick:goToNextPage,disabled:currentPage===totalPages,className:\"btn btn-pagination\",children:\"Next \\u2192\"})]})})]});};export default CallLogsTable;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}