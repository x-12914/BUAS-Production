{"ast":null,"code":"import _objectSpread from\"/home/opt/BUAS/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useMemo}from'react';import AudioPlayer from'./AudioPlayer';import ApiService from'../services/api';import'./RecordingEventsTable.css';import{jsxs as _jsxs,jsx as _jsx}from\"react/jsx-runtime\";const RecordingEventsTable=_ref=>{let{data=[],deviceId,audioFiles=[],onDataChange}=_ref;const[searchTerm,setSearchTerm]=useState('');const[sortField,setSortField]=useState('start_timestamp');const[sortDirection,setSortDirection]=useState('desc');const[currentPage,setCurrentPage]=useState(1);const[currentAudio,setCurrentAudio]=useState(null);const[showAudioPlayer,setShowAudioPlayer]=useState(false);const itemsPerPage=10;// Filter and sort data\nconst filteredAndSortedData=useMemo(()=>{let filtered=data;// Apply search filter\nif(searchTerm){filtered=filtered.filter(item=>{var _item$stop_timestamp,_item$stop_location,_item$stop_location2;return item.start_timestamp.toLowerCase().includes(searchTerm.toLowerCase())||((_item$stop_timestamp=item.stop_timestamp)===null||_item$stop_timestamp===void 0?void 0:_item$stop_timestamp.toLowerCase().includes(searchTerm.toLowerCase()))||item.start_location.lat.toString().includes(searchTerm)||item.start_location.lng.toString().includes(searchTerm)||((_item$stop_location=item.stop_location)===null||_item$stop_location===void 0?void 0:_item$stop_location.lat.toString().includes(searchTerm))||((_item$stop_location2=item.stop_location)===null||_item$stop_location2===void 0?void 0:_item$stop_location2.lng.toString().includes(searchTerm));});}// Apply sorting\nfiltered.sort((a,b)=>{let aValue,bValue;if(sortField==='start_timestamp'){aValue=new Date(a.start_timestamp);bValue=new Date(b.start_timestamp);}else if(sortField==='stop_timestamp'){aValue=new Date(a.stop_timestamp||0);bValue=new Date(b.stop_timestamp||0);}else if(sortField==='start_latitude'){aValue=a.start_location.lat;bValue=b.start_location.lat;}else if(sortField==='start_longitude'){aValue=a.start_location.lng;bValue=b.start_location.lng;}if(sortDirection==='asc'){return aValue>bValue?1:-1;}else{return aValue<bValue?1:-1;}});return filtered;},[data,searchTerm,sortField,sortDirection]);// Pagination\nconst totalPages=Math.ceil(filteredAndSortedData.length/itemsPerPage);const paginatedData=filteredAndSortedData.slice((currentPage-1)*itemsPerPage,currentPage*itemsPerPage);const handleSort=field=>{if(sortField===field){setSortDirection(sortDirection==='asc'?'desc':'asc');}else{setSortField(field);setSortDirection('desc');}};const exportToCSV=async()=>{// Use new format headers with separate Date and Time columns\nconst headers=['Device_ID','Start_Date_WAT','Start_Time_WAT','Start_Latitude','Start_Longitude','Stop_Date_WAT','Stop_Time_WAT','Stop_Latitude','Stop_Longitude','Audio_File_ID','Audio_Link'];// Resolve audio files for all items\nconst resolvedData=await Promise.all(filteredAndSortedData.map(async item=>{let audioFileName='';let audioLink='';try{// Use the new audio file resolution API\nconst startDate=item.start_date||(item.start_timestamp?new Date(item.start_timestamp).toISOString().split('T')[0]:'');const startTime=item.start_time||(item.start_timestamp?new Date(item.start_timestamp).toTimeString().split(' ')[0]:'');const response=await ApiService.resolveAudioFile(item.device_id||deviceId,item.audio_file_id,startDate,startTime);if(response.success&&response.actual_filename){audioFileName=response.actual_filename;audioLink=response.audio_url;}else{audioFileName='No audio file found';audioLink='Audio Not Available';}}catch(error){console.error('Error resolving audio file:',error);audioFileName='Error resolving audio';audioLink='Audio Not Available';}return _objectSpread(_objectSpread({},item),{},{audioFileName,audioLink});}));const csvData=[headers.join(','),...resolvedData.map(item=>{// Handle both new and old formats\nif(item.start_date&&item.start_time){// New format\nreturn\"\".concat(item.device_id||deviceId,\",\").concat(item.start_date,\",\").concat(item.start_time,\",\").concat(item.start_latitude||'',\",\").concat(item.start_longitude||'',\",\").concat(item.stop_date||'',\",\").concat(item.stop_time||'',\",\").concat(item.stop_latitude||'',\",\").concat(item.stop_longitude||'',\",\").concat(item.audioFileName,\",\").concat(item.audioLink);}else{var _item$start_location,_item$start_location2,_item$stop_location3,_item$stop_location4;// Old format - convert timestamps to date/time\nconst startDate=item.start_timestamp?new Date(item.start_timestamp).toISOString().split('T')[0]:'';const startTime=item.start_timestamp?new Date(item.start_timestamp).toTimeString().split(' ')[0]:'';const stopDate=item.stop_timestamp?new Date(item.stop_timestamp).toISOString().split('T')[0]:'';const stopTime=item.stop_timestamp?new Date(item.stop_timestamp).toTimeString().split(' ')[0]:'';return\"\".concat(deviceId,\",\").concat(startDate,\",\").concat(startTime,\",\").concat(((_item$start_location=item.start_location)===null||_item$start_location===void 0?void 0:_item$start_location.lat)||'',\",\").concat(((_item$start_location2=item.start_location)===null||_item$start_location2===void 0?void 0:_item$start_location2.lng)||'',\",\").concat(stopDate,\",\").concat(stopTime,\",\").concat(((_item$stop_location3=item.stop_location)===null||_item$stop_location3===void 0?void 0:_item$stop_location3.lat)||'',\",\").concat(((_item$stop_location4=item.stop_location)===null||_item$stop_location4===void 0?void 0:_item$stop_location4.lng)||'',\",\").concat(item.audioFileName,\",\").concat(item.audioLink);}})].join('\\n');const blob=new Blob([csvData],{type:'text/csv'});const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=\"\".concat(deviceId,\"_recording_events_WAT.csv\");a.click();window.URL.revokeObjectURL(url);};const exportToExcel=async()=>{const headers=['Start Timestamp','Start Latitude','Start Longitude','Stop Timestamp','Stop Latitude','Stop Longitude','Audio File ID','Audio Link'];// Resolve audio files for all items\nconst resolvedData=await Promise.all(filteredAndSortedData.map(async item=>{let audioFileName='';let audioLink='';try{// Use the new audio file resolution API\nconst startDate=item.start_date||(item.start_timestamp?new Date(item.start_timestamp).toISOString().split('T')[0]:'');const startTime=item.start_time||(item.start_timestamp?new Date(item.start_timestamp).toTimeString().split(' ')[0]:'');const response=await ApiService.resolveAudioFile(item.device_id||deviceId,item.audio_file_id,startDate,startTime);if(response.success&&response.actual_filename){audioFileName=response.actual_filename;audioLink=response.audio_url;}else{audioFileName='No audio file found';audioLink='Audio Not Available';}}catch(error){console.error('Error resolving audio file:',error);audioFileName='Error resolving audio';audioLink='Audio Not Available';}return _objectSpread(_objectSpread({},item),{},{audioFileName,audioLink});}));const tsvData=[headers.join('\\t'),...resolvedData.map(item=>{var _item$stop_location5,_item$stop_location6;return\"\".concat(item.start_timestamp,\"\\t\").concat(item.start_location.lat,\"\\t\").concat(item.start_location.lng,\"\\t\").concat(item.stop_timestamp||'',\"\\t\").concat(((_item$stop_location5=item.stop_location)===null||_item$stop_location5===void 0?void 0:_item$stop_location5.lat)||'',\"\\t\").concat(((_item$stop_location6=item.stop_location)===null||_item$stop_location6===void 0?void 0:_item$stop_location6.lng)||'',\"\\t\").concat(item.audioFileName,\"\\t\").concat(item.audioLink);})].join('\\n');const blob=new Blob([tsvData],{type:'text/tab-separated-values'});const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=\"\".concat(deviceId,\"_recording_events.xlsx\");a.click();window.URL.revokeObjectURL(url);};const formatTimestamp=timestamp=>{if(!timestamp)return'N/A';return new Date(timestamp).toLocaleString();};const getSortIcon=field=>{if(sortField!==field)return'↕️';return sortDirection==='asc'?'↑':'↓';};// Audio control functions\nconst hasAudioFile=item=>{// Primary check: does the item have an audio_file_id?\nif(item.audio_file_id&&item.audio_file_id.trim()!==''){return true;}// For recent uploads, be more strict - don't show play button unless we have specific file ID\n// This prevents the issue where recent uploads would play previous audio\nconst recordingDate=new Date(item.start_timestamp||\"\".concat(item.start_date,\" \").concat(item.start_time));const now=new Date();const timeDiff=now-recordingDate;const isRecent=timeDiff<5*60*1000;// Less than 5 minutes ago\nif(isRecent){// For recent recordings, only show play button if we have specific audio_file_id\nreturn false;}// Fallback check: are there any audio files for this device? (only for older recordings)\nif(audioFiles&&audioFiles.length>0){return true;}return false;};const getAudioFileForItem=async item=>{try{// Use the new audio file resolution API\nconst startDate=item.start_date||(item.start_timestamp?new Date(item.start_timestamp).toISOString().split('T')[0]:'');const startTime=item.start_time||(item.start_timestamp?new Date(item.start_timestamp).toTimeString().split(' ')[0]:'');const response=await ApiService.resolveAudioFile(item.device_id||deviceId,item.audio_file_id,startDate,startTime);if(response.success&&response.actual_filename){return response.actual_filename;}}catch(error){console.error('Error resolving audio file:',error);}return null;};const handlePlay=async item=>{if(!hasAudioFile(item))return;const audioFileName=await getAudioFileForItem(item);if(!audioFileName){console.warn(\"No audio file found for recording: \".concat(item.start_timestamp||\"\".concat(item.start_date,\" \").concat(item.start_time)));return;}// Get the API base URL for proper absolute URL construction\nconst fullAudioUrl=\"\".concat(ApiService.baseURL,\"/api/uploads/\").concat(audioFileName);// Create audio object for player\nconst audioData={url:fullAudioUrl,filename:audioFileName,user:deviceId,timestamp:item.start_timestamp||\"\".concat(item.start_date,\" \").concat(item.start_time)};setCurrentAudio(audioData);setShowAudioPlayer(true);};const handleDownload=async item=>{if(!hasAudioFile(item))return;const audioFileName=await getAudioFileForItem(item);if(!audioFileName)return;// Get the API base URL for proper absolute URL construction\nconst fullAudioUrl=\"\".concat(ApiService.baseURL,\"/api/uploads/\").concat(audioFileName);// Create download link (same approach as AudioPlayer)\nconst link=document.createElement('a');link.href=fullAudioUrl;link.download=audioFileName;link.target='_blank';link.rel='noopener noreferrer';// Trigger download\ndocument.body.appendChild(link);link.click();document.body.removeChild(link);};const closeAudioPlayer=()=>{setShowAudioPlayer(false);setCurrentAudio(null);};return/*#__PURE__*/_jsxs(\"div\",{className:\"recording-events-table-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"table-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"table-title\",children:[/*#__PURE__*/_jsxs(\"h3\",{children:[\"\\uD83C\\uDFB5 Recording Events (\",filteredAndSortedData.length,\" events)\"]}),/*#__PURE__*/_jsx(\"p\",{children:\"Location data when recording started and stopped\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"table-controls\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"search-container\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Search recording events...\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"search-input\"}),/*#__PURE__*/_jsx(\"span\",{className:\"search-icon\",children:\"\\uD83D\\uDD0D\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"export-buttons\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:exportToCSV,className:\"btn btn-export\",children:\"\\uD83D\\uDCC4 Export CSV\"}),/*#__PURE__*/_jsx(\"button\",{onClick:exportToExcel,className:\"btn btn-export\",children:\"\\uD83D\\uDCCA Export Excel\"})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"table-wrapper\",children:/*#__PURE__*/_jsxs(\"table\",{className:\"recording-events-table\",children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsxs(\"th\",{onClick:()=>handleSort('start_timestamp'),className:\"sortable\",children:[\"START DATE(YYYY-MM-DD) \",getSortIcon('start_timestamp')]}),/*#__PURE__*/_jsx(\"th\",{children:\"Start Time (WAT)\"}),/*#__PURE__*/_jsxs(\"th\",{onClick:()=>handleSort('start_latitude'),className:\"sortable\",children:[\"START LATITUDE(N) \",getSortIcon('start_latitude')]}),/*#__PURE__*/_jsxs(\"th\",{onClick:()=>handleSort('start_longitude'),className:\"sortable\",children:[\"START LONGITUDE(E) \",getSortIcon('start_longitude')]}),/*#__PURE__*/_jsxs(\"th\",{onClick:()=>handleSort('stop_timestamp'),className:\"sortable\",children:[\"STOP DATE(YYYY-MM-DD) \",getSortIcon('stop_timestamp')]}),/*#__PURE__*/_jsx(\"th\",{children:\"Stop Time (WAT)\"}),/*#__PURE__*/_jsx(\"th\",{children:\"STOP LATITUDE(N)\"}),/*#__PURE__*/_jsx(\"th\",{children:\"STOP LONGITUDE(E)\"}),/*#__PURE__*/_jsx(\"th\",{children:\"AUDIO CONTROLS\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:paginatedData.length===0?/*#__PURE__*/_jsx(\"tr\",{children:/*#__PURE__*/_jsx(\"td\",{colSpan:\"9\",className:\"no-data\",children:searchTerm?'No matching records found':'No recording events available'})}):paginatedData.map((item,index)=>{var _item$start_location3,_item$start_location4,_item$stop_location7,_item$stop_location8;// Handle both new format (date/time) and old format (timestamp)\nconst hasNewFormat=item.start_date&&item.start_time;return/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.start_date:item.start_timestamp?new Date(item.start_timestamp).toISOString().split('T')[0]:'N/A'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.start_time:item.start_timestamp?new Date(item.start_timestamp).toTimeString().split(' ')[0]:'N/A'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.start_latitude?item.start_latitude.toFixed(6):'N/A':(_item$start_location3=item.start_location)!==null&&_item$start_location3!==void 0&&_item$start_location3.lat?item.start_location.lat.toFixed(6):'N/A'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.start_longitude?item.start_longitude.toFixed(6):'N/A':(_item$start_location4=item.start_location)!==null&&_item$start_location4!==void 0&&_item$start_location4.lng?item.start_location.lng.toFixed(6):'N/A'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.stop_date||'Active':item.stop_timestamp?new Date(item.stop_timestamp).toISOString().split('T')[0]:'Active'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.stop_time||'-':item.stop_timestamp?new Date(item.stop_timestamp).toTimeString().split(' ')[0]:'-'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.stop_latitude?item.stop_latitude.toFixed(6):'-':(_item$stop_location7=item.stop_location)!==null&&_item$stop_location7!==void 0&&_item$stop_location7.lat?item.stop_location.lat.toFixed(6):'-'}),/*#__PURE__*/_jsx(\"td\",{children:hasNewFormat?item.stop_longitude?item.stop_longitude.toFixed(6):'-':(_item$stop_location8=item.stop_location)!==null&&_item$stop_location8!==void 0&&_item$stop_location8.lng?item.stop_location.lng.toFixed(6):'-'}),/*#__PURE__*/_jsx(\"td\",{className:\"audio-controls-cell\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"audio-controls\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"audio-btn play-btn \".concat(!hasAudioFile(item)?'disabled':''),onClick:()=>handlePlay(item),disabled:!hasAudioFile(item),title:hasAudioFile(item)?'Play audio recording':'No audio file available',children:[/*#__PURE__*/_jsx(\"span\",{className:\"btn-icon\",children:\"\\uD83C\\uDFB5\"}),/*#__PURE__*/_jsx(\"span\",{className:\"btn-text\",children:\"Play\"})]}),/*#__PURE__*/_jsxs(\"button\",{className:\"audio-btn download-btn \".concat(!hasAudioFile(item)?'disabled':''),onClick:()=>handleDownload(item),disabled:!hasAudioFile(item),title:hasAudioFile(item)?'Download audio file':'No audio file available',children:[/*#__PURE__*/_jsx(\"span\",{className:\"btn-icon\",children:\"\\uD83D\\uDCBE\"}),/*#__PURE__*/_jsx(\"span\",{className:\"btn-text\",children:\"Download\"})]})]})})]},item.id||index);})})]})}),totalPages>1&&/*#__PURE__*/_jsxs(\"div\",{className:\"pagination\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setCurrentPage(Math.max(1,currentPage-1)),disabled:currentPage===1,className:\"btn btn-pagination\",children:\"\\u2190 Previous\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"page-info\",children:[\"Page \",currentPage,\" of \",totalPages]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setCurrentPage(Math.min(totalPages,currentPage+1)),disabled:currentPage===totalPages,className:\"btn btn-pagination\",children:\"Next \\u2192\"})]}),showAudioPlayer&&currentAudio&&/*#__PURE__*/_jsx(AudioPlayer,{audio:currentAudio,onClose:closeAudioPlayer})]});};export default RecordingEventsTable;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}