{"ast":null,"code":"import _objectSpread from\"/home/opt/BUAS/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import{useParams,useNavigate,useLocation}from'react-router-dom';import SmsTable from'./SmsTable';import ApiService from'../services/api';import'./DeviceSmsHistory.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const DeviceSmsHistory=()=>{var _location$state,_location$state2,_location$state3;const{deviceId}=useParams();const navigate=useNavigate();const location=useLocation();// Debug logging\nconsole.log('DeviceSmsHistory - deviceId:',deviceId);console.log('DeviceSmsHistory - current location:',location.pathname);const[smsData,setSmsData]=useState(((_location$state=location.state)===null||_location$state===void 0?void 0:_location$state.smsData)||[]);const[deviceInfo,setDeviceInfo]=useState(((_location$state2=location.state)===null||_location$state2===void 0?void 0:_location$state2.deviceInfo)||null);const[loading,setLoading]=useState(!((_location$state3=location.state)!==null&&_location$state3!==void 0&&_location$state3.smsData));const[error,setError]=useState(null);const[summary,setSummary]=useState({total_messages:0,unread_messages:0,read_messages:0,unique_senders:0});// Filter state for API calls\nconst[searchTerm,setSearchTerm]=useState('');const[senderFilter,setSenderFilter]=useState('');const[statusFilter,setStatusFilter]=useState('');const[dateFromFilter,setDateFromFilter]=useState('');const[dateToFilter,setDateToFilter]=useState('');// Helper function to fetch all SMS data across multiple pages\nconst fetchAllSmsData=async baseParams=>{let allSmsData=[];let page=1;let hasMore=true;let totalSummary={};while(hasMore){const params=_objectSpread(_objectSpread({},baseParams),{},{page:page,per_page:100// Use max allowed per page\n});const response=await ApiService.getDeviceSms(deviceId,params);if(response.sms_messages&&response.sms_messages.length>0){var _response$pagination;allSmsData=[...allSmsData,...response.sms_messages];totalSummary=response.summary||{};hasMore=((_response$pagination=response.pagination)===null||_response$pagination===void 0?void 0:_response$pagination.has_next)||false;page++;}else{hasMore=false;}}return{sms_messages:allSmsData,summary:totalSummary};};const fetchData=async()=>{try{var _location$state4;const baseParams={};if(dateFromFilter)baseParams.date_from=dateFromFilter;if(dateToFilter)baseParams.date_to=dateToFilter;if(senderFilter)baseParams.sender=senderFilter;if(statusFilter)baseParams.status=statusFilter;if(searchTerm)baseParams.search=searchTerm;const[smsResponse,deviceResponse]=await Promise.all([fetchAllSmsData(baseParams),(_location$state4=location.state)!==null&&_location$state4!==void 0&&_location$state4.deviceInfo?Promise.resolve({data:location.state.deviceInfo}):ApiService.getDeviceDetails(deviceId)]);setSmsData(smsResponse.sms_messages||[]);setSummary(smsResponse.summary||{});setDeviceInfo(deviceResponse.data);setError(null);}catch(err){setError('Failed to load SMS data');console.error('Error fetching SMS data:',err);}finally{setLoading(false);}};useEffect(()=>{// Initial load and filter changes\nfetchData();// Continue real-time polling regardless\nconst interval=setInterval(()=>fetchData(),10000);return()=>clearInterval(interval);},[deviceId,location.state,dateFromFilter,dateToFilter,senderFilter,statusFilter,searchTerm]);// Handler for data refresh after changes\nconst handleDataChange=async()=>{try{const baseParams={};if(dateFromFilter)baseParams.date_from=dateFromFilter;if(dateToFilter)baseParams.date_to=dateToFilter;if(senderFilter)baseParams.sender=senderFilter;if(statusFilter)baseParams.status=statusFilter;if(searchTerm)baseParams.search=searchTerm;const smsResponse=await fetchAllSmsData(baseParams);setSmsData(smsResponse.sms_messages||[]);setSummary(smsResponse.summary||{});}catch(err){console.error('Error refreshing SMS data:',err);}};// Handlers for filter changes\nconst handleFilterChange=filters=>{setSearchTerm(filters.searchTerm||'');setSenderFilter(filters.senderFilter||'');setStatusFilter(filters.statusFilter||'');setDateFromFilter(filters.dateFromFilter||'');setDateToFilter(filters.dateToFilter||'');};if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"device-sms-history-container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"loading-sms\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Loading SMS messages...\"})]})});}if(error){return/*#__PURE__*/_jsx(\"div\",{className:\"device-sms-history-container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"error-state\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"\\u274C Error\"}),/*#__PURE__*/_jsx(\"p\",{children:error}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate(\"/device/\".concat(deviceId)),className:\"btn btn-secondary\",children:\"\\u2190 Back to Device Details\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"device-sms-history-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"sms-history-header\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:e=>{e.preventDefault();e.stopPropagation();console.log('Back button clicked!');console.log('DeviceId:',deviceId);console.log('Current location:',location.pathname);// Use window.location.href for reliable navigation\nwindow.location.href=\"/device/\".concat(deviceId);},className:\"back-button\",style:{position:'relative',zIndex:1000,pointerEvents:'auto'},children:\"\\u2190 Back to Device Details\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"sms-history-title\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\uD83D\\uDCF1 Device SMS Messages\"}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Device: \",deviceId]}),deviceInfo&&/*#__PURE__*/_jsx(\"div\",{className:\"device-status-info\",children:/*#__PURE__*/_jsxs(\"span\",{className:\"sms-count\",children:[summary.total_messages,\" SMS messages\"]})})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"sms-table-section\",children:/*#__PURE__*/_jsx(SmsTable,{data:smsData,summary:summary,deviceId:deviceId,deviceInfo:deviceInfo,onDataChange:handleDataChange,onFilterChange:handleFilterChange})})]});};export default DeviceSmsHistory;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}