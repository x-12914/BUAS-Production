{"ast":null,"code":"import React,{useState,useEffect}from'react';import StatusBar from'./StatusBar';import UserList from'./UserList';import ConnectionStatus from'./ConnectionStatus';import DashboardMap from'./DashboardMap';import BatchRecordingControls from'./BatchRecordingControls';import UserManagement from'./UserManagement';import AuditLogs from'./AuditLogs';import AnalystDashboard from'./AnalystDashboard';import OperatorDashboard from'./OperatorDashboard';import SuperUserDashboard from'./SuperUserDashboard';import ApiService from'../services/api';import authService from'../services/authService';import'./Dashboard.css';import'./RoleDashboards.css';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Dashboard=_ref=>{var _currentUser$role;let{user,onLogout}=_ref;// State Management\nconst[dashboardData,setDashboardData]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[isPolling,setIsPolling]=useState(true);const[lastUpdated,setLastUpdated]=useState(null);const[connectionStatus,setConnectionStatus]=useState('connecting');const[selectedUser,setSelectedUser]=useState(null);const[activeTab,setActiveTab]=useState('devices');// 'devices', 'map', or 'users'\nconst[showUserMenu,setShowUserMenu]=useState(false);const[currentUser,setCurrentUser]=useState(user);// Local state for user data\n// Define functions first to avoid hoisting issues\nconst fetchDashboardData=async()=>{try{// First check if server is healthy\ntry{await ApiService.getHealthCheck();}catch(healthError){console.warn('Health check failed, but attempting dashboard data fetch...');}const data=await ApiService.getDashboardData();setDashboardData(data);setConnectionStatus(data.connection_status||'connected');setLastUpdated(new Date());setError(null);}catch(err){console.error('Failed to fetch dashboard data:',err);setError(err.message);setConnectionStatus('error');}finally{setLoading(false);}};// Real-time Polling with 2-second intervals\nuseEffect(()=>{let pollInterval;if(isPolling){// Initial fetch\nfetchDashboardData();// Set up polling\npollInterval=setInterval(fetchDashboardData,2000);}return()=>{if(pollInterval){clearInterval(pollInterval);}};},[isPolling]);// Ensure user data is in sync - refresh if user prop is null but authService has user\nuseEffect(()=>{if(!user&&authService.isAuthenticated()){// Force parent to update user data\nconst serviceUser=authService.getCurrentUser();if(serviceUser){setCurrentUser(serviceUser);// Use service user as fallback\n}}else{setCurrentUser(user);// Use prop user when available\n}},[user]);// Listen for auth changes to update user data in real time\nuseEffect(()=>{const handleAuthChange=userData=>{setCurrentUser(userData);};authService.addAuthListener(handleAuthChange);return()=>{authService.removeAuthListener(handleAuthChange);};},[]);// Handle user actions\nconst togglePolling=()=>{setIsPolling(!isPolling);};const handleLogout=async()=>{await authService.logout();if(onLogout){onLogout();}};const handleChangePassword=()=>{window.location.href='/change-password';};const toggleUserMenu=()=>{setShowUserMenu(!showUserMenu);};// Close user menu when clicking outside\nuseEffect(()=>{const handleClickOutside=event=>{if(showUserMenu&&!event.target.closest('.user-menu')){setShowUserMenu(false);}};document.addEventListener('mousedown',handleClickOutside);return()=>{document.removeEventListener('mousedown',handleClickOutside);};},[showUserMenu]);const getRoleBadgeClass=role=>{return\"role-badge \".concat(role.replace('_','-'));};// Render role-specific dashboard content\nconst renderDashboardContent=()=>{const role=currentUser===null||currentUser===void 0?void 0:currentUser.role;switch(role){case'analyst':return/*#__PURE__*/_jsx(AnalystDashboard,{user:currentUser,dashboardData:dashboardData,loading:loading,selectedUser:selectedUser,onUserSelect:setSelectedUser});case'operator':return/*#__PURE__*/_jsx(OperatorDashboard,{user:currentUser,dashboardData:dashboardData,loading:loading,selectedUser:selectedUser,onUserSelect:setSelectedUser,isPolling:isPolling});case'super_user':return/*#__PURE__*/_jsx(SuperUserDashboard,{user:currentUser,dashboardData:dashboardData,loading:loading,selectedUser:selectedUser,onUserSelect:setSelectedUser,isPolling:isPolling});case'super_super_admin':default:// Default/Super Super Admin view - full access\nreturn/*#__PURE__*/_jsxs(\"div\",{className:\"super-admin-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard-tabs\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"tab-button \".concat(activeTab==='devices'?'active':''),onClick:()=>setActiveTab('devices'),children:\"\\uD83D\\uDCF1 Device List\"}),/*#__PURE__*/_jsx(\"button\",{className:\"tab-button \".concat(activeTab==='map'?'active':''),onClick:()=>setActiveTab('map'),children:\"\\uD83D\\uDDFA\\uFE0F Location Map\"}),/*#__PURE__*/_jsx(\"button\",{className:\"tab-button \".concat(activeTab==='users'?'active':''),onClick:()=>setActiveTab('users'),children:\"\\uD83D\\uDC65 User Management\"}),((currentUser===null||currentUser===void 0?void 0:currentUser.role)==='super_user'||(currentUser===null||currentUser===void 0?void 0:currentUser.role)==='super_super_admin')&&/*#__PURE__*/_jsx(\"button\",{className:\"tab-button \".concat(activeTab==='audit'?'active':''),onClick:()=>setActiveTab('audit'),children:\"\\uD83D\\uDCCB Audit Logs\"})]}),activeTab==='devices'&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(BatchRecordingControls,{devices:(dashboardData===null||dashboardData===void 0?void 0:dashboardData.users)||[],disabled:loading||!isPolling}),/*#__PURE__*/_jsx(UserList,{users:(dashboardData===null||dashboardData===void 0?void 0:dashboardData.users)||[],loading:loading,selectedUser:selectedUser,onUserSelect:setSelectedUser})]}),activeTab==='map'&&/*#__PURE__*/_jsx(DashboardMap,{}),activeTab==='users'&&/*#__PURE__*/_jsx(UserManagement,{}),activeTab==='audit'&&/*#__PURE__*/_jsx(AuditLogs,{user:currentUser})]});}};if(loading&&!dashboardData){return/*#__PURE__*/_jsx(\"div\",{className:\"dashboard dark-theme\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"loading-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Loading BUAS Dashboard...\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard dark-theme\",children:[/*#__PURE__*/_jsx(\"header\",{className:\"dashboard-header\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"header-content\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\uD83E\\uDD87 BUAS Dashboard\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"header-right\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard-controls\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"polling-toggle \".concat(isPolling?'active':''),onClick:togglePolling,children:[isPolling?'⏸️':'▶️',isPolling?'Pause Updates':'Resume Updates']}),/*#__PURE__*/_jsxs(\"div\",{className:\"polling-indicator\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"indicator-dot \".concat(isPolling?'active':'')}),/*#__PURE__*/_jsx(\"span\",{children:\"Live Updates\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-menu\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"user-menu-toggle\",onClick:toggleUserMenu,children:[/*#__PURE__*/_jsxs(\"span\",{className:\"user-info\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"username\",children:(currentUser===null||currentUser===void 0?void 0:currentUser.username)||'User'}),/*#__PURE__*/_jsx(\"span\",{className:getRoleBadgeClass((currentUser===null||currentUser===void 0?void 0:currentUser.role)||'operator'),children:(currentUser===null||currentUser===void 0?void 0:(_currentUser$role=currentUser.role)===null||_currentUser$role===void 0?void 0:_currentUser$role.replace('_',' '))||'Loading...'})]}),/*#__PURE__*/_jsx(\"span\",{className:\"menu-arrow\",children:showUserMenu?'▲':'▼'})]}),showUserMenu&&/*#__PURE__*/_jsxs(\"div\",{className:\"user-menu-dropdown\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"user-menu-header\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"user-details\",children:[/*#__PURE__*/_jsx(\"strong\",{children:(currentUser===null||currentUser===void 0?void 0:currentUser.username)||'User'}),/*#__PURE__*/_jsx(\"small\",{children:(currentUser===null||currentUser===void 0?void 0:currentUser.agency_name)||'Briech UAS'})]})}),/*#__PURE__*/_jsx(\"button\",{className:\"user-menu-item\",onClick:handleChangePassword,children:\"\\uD83D\\uDD12 Change Password\"}),((currentUser===null||currentUser===void 0?void 0:currentUser.role)==='super_super_admin'||(currentUser===null||currentUser===void 0?void 0:currentUser.role)==='super_user')&&/*#__PURE__*/_jsx(\"button\",{className:\"user-menu-item\",onClick:()=>{setActiveTab('users');setShowUserMenu(false);},children:\"\\uD83D\\uDC65 User Management\"}),/*#__PURE__*/_jsx(\"hr\",{className:\"menu-divider\"}),/*#__PURE__*/_jsx(\"button\",{className:\"user-menu-item danger\",onClick:handleLogout,children:\"\\uD83D\\uDEAA Logout\"})]})]})]})]})}),/*#__PURE__*/_jsx(StatusBar,{data:dashboardData,connectionStatus:connectionStatus,lastUpdated:lastUpdated,error:error}),/*#__PURE__*/_jsx(\"main\",{className:\"dashboard-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard-main\",children:[/*#__PURE__*/_jsx(ConnectionStatus,{status:connectionStatus,lastUpdated:lastUpdated,isPolling:isPolling}),renderDashboardContent()]})}),/*#__PURE__*/_jsx(\"footer\",{className:\"dashboard-footer\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"footer-content\",children:[/*#__PURE__*/_jsxs(\"p\",{children:[\"BUAS Dashboard v1.0.0 | Last Updated: \",lastUpdated===null||lastUpdated===void 0?void 0:lastUpdated.toLocaleTimeString()]}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Connected Users: \",(dashboardData===null||dashboardData===void 0?void 0:dashboardData.total_users)||0,\" | Active Sessions: \",(dashboardData===null||dashboardData===void 0?void 0:dashboardData.active_sessions_count)||0]})]})})]});};export default Dashboard;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}